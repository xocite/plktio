<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="themes/test/style.css" rel="stylesheet">
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-144235537-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-144235537-2');
</script>
<title>Creating a disposable dev environment using libvirt &#8211; AJONLINE</title>
<link rel='dns-prefetch' href='https://s.w.org/' />
<link rel="alternate" type="application/rss+xml" title="AJONLINE &raquo; Creating a disposable dev environment using libvirt Comments Feed" href="https://antonyjepson.co.uk/disposable-dev-environment/feed/" />
<link rel='stylesheet' id='wp-block-library-css'  href='css/dist/block-library/style.min.css?ver=5.2.2' type='text/css' media='all' />
<link rel='https://api.w.org/' href='https://antonyjepson.co.uk/wp-json/' />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="xmlrpc.php?rsd" />
<link rel='prev' title='Selectively applying changes with Git Stash' href='index.html?p=700' />
<link rel='next' title='VLAN Primer' href='index.html?p=714' />
<meta name="generator" content="WordPress 5.2.2" />
<link rel="canonical" href="index.html?p=707" />
<link rel='shortlink' href='index.html?p=707' />
<link rel="icon" href="uploads/2018/11/favicon.ico" sizes="32x32" />
<link rel="icon" href="uploads/2018/11/favicon.ico" sizes="192x192" />
<link rel="apple-touch-icon-precomposed" href="uploads/2018/11/favicon.ico" />
<meta name="msapplication-TileImage" content="https://antonyjepson.co.uk/wp-content/uploads/2018/11/favicon.ico" />
</head>
<body>
<div class="gc">
<div class="gi0">
<nav>
<img class="logo" src="uploads/2018/11/favicon.ico" />
<header class="nav">
<a href="https://antonyjepson.co.uk">AJONLINE</a>
</header>
<br /><br /><br />
<li class="page_item page-item-80"><a href="index.html?p=80">About</a></li>
<li class="page_item page-item-596"><a href="index.html?p=596">Contact and Consulting</a></li>
<li class="page_item page-item-668"><a href="index.html?p=668">License</a></li>
<li class="page_item page-item-613"><a href="index.html?p=613">Resume</a></li>
<br />
</nav>
</div> <!-- end gi0 -->
<div class="gi1">

<article>
<header>Creating a disposable dev environment using libvirt</header>
<em>When AWS Elastic Compute Cloud was first launched in 2006 [1] it was lauded as the future of scalable, on-demand web services. The first use cases explained that up to 20 instances per account could be launched, each with access to a virtualised 1.7 GHz Xeon processor, 1.75 GB of RAM, 160 GB (!) of [&hellip;]</em><br /><em>6 February 2019</em>

<p>When AWS Elastic Compute Cloud was first launched in 2006 [1] it was lauded as the future of scalable, on-demand web services.  The first use cases explained that up to 20 instances per account could be launched, each with access to a virtualised 1.7 GHz Xeon processor, 1.75 GB of RAM, 160 GB (!) of disk space, and a sustained 250 Mb/second of bandwidth.<br>
Fast-forward to 2019 and it&#8217;s never been easier to create your own instance on your server at home (or at work).  This is thanks to libvirt and associated tools to make provisioning and partitioning the resources simple and reproducible.<br>
In this guide I&#8217;ll be showing you how to create a base image on your machine that you can use to run a disposable dev environment for testing new packages or kernels.</p>



<p>We&#8217;ll be using Debian 9 &#8220;Stretch&#8221; and because libvirt is common to many distros the instructions should carry over nicely.</p>



<p>To get started, install the necessary tools.<br>
$ sudo apt install libvirt-daemon virtinst libguestfs-tools virt-manager</p>



<p>Next, download the Debian 9 ISO [2].  I used /data/virt/img</p>



<p>Next we&#8217;ll use virsh, the libvirt CLI, to configure and install the VM.  For this VM we&#8217;ll want the following:</p>



<ul><li>256MB RAM</li><li>20GB disk</li><li>1 vCPU</li><li>network bridged using macvtap</li></ul>



<pre class="wp-block-preformatted">$ virt-install --connect qemu:///system --os-variant debian9 --vcpus 1 --memory 256 --name debian-dev-env-2 --disk size=10,path=/data/virt/vhd/debian-dev-env.qcow2,format=qcow2 --cdrom /data/virt/img/debian-9.7.0-amd64-netinst.iso --network type=direct,source=enp4s0 --input tablet --graphics vnc,password=virt,port=5900 --transient</pre>



<p>Connect via VNC port 5900 on the host if the VNC viewer didn&#8217;t already launch via virt-viewer.</p>



<p>After the installation is done shutdown the guest and you should now have a virtual image you can boot from.  In my case, this image is stored at /data/virt/vhd/debian-dev-env.qcow2.</p>



<p>Now let&#8217;s copy our SSH key into the base image.  This assumes the user you created is called local and the user running the virt-sysprep command is called user</p>



<pre class="wp-block-preformatted">$ virt-sysprep --ssh-inject local:file:/home/user/.ssh/denv-rsa.pub --add /data/virt/vhd/debian-dev-env.qcow2</pre>



<p>Finally, we&#8217;ll enable the serial console in the event that we no longer have VNC.  Notice the new &#8220;&#8211;import&#8221; option.</p>



<pre class="wp-block-preformatted">$ virt-install --connect qemu:///system --os-variant debian9 --import --vcpus 1 --memory 256 --name debian --disk /data/virt/vhd/debian-dev-env.qcow2,format=qcow2 --network type=direct,source=enp4s0 --input tablet --graphics vnc,password=virt,port=5900 --transient</pre>



<p>Log in via root andâ€¦.</p>



<pre class="wp-block-preformatted"># systemctl enable serial-getty@ttyS0.service</pre>



<p><pre class="wp-block-preformatted"># poweroff</pre></p>



<p>Finally, our development environment is ready. We can launch it whenever we need one by creating a snapshot of the base volume and using that to launch virt-install.</p>



<pre class="wp-block-preformatted"> $ chmod 400 /data/virt/vhd/debian-dev-env.qcow2<br> $ qemu-img create -f qcow2 -o backing_file=/data/virt/vhd/debian-dev-env.qcow2 /data/virt/snap/debian-9.qcow2_snapshot<br> $ virt-install --connect qemu:///system --os-variant debian9 --import --vcpus 1 --memory 256 --name debian --disk /data/virt/snap/debian-9.qcow2_snapshot,format=qcow2 --network type=direct,source=enp4s0 --graphics none --transient<br> $ ssh user@debian</pre>



<p>When you are done, just shutdown.</p>



<p>If you want a fresh installation, create a new snapshot of the base image and use that as the new base.</p>



<p>I haven&#8217;t figured out a good way to automate this in a fail-safe manner with one command line yet.  I&#8217;ll update this post when I have.</p>



<p>[1]: https://aws.amazon.com/blogs/aws/amazon_ec2_beta/ </p>



<p>[2]: https://www.debian.org/CD</p>



<p></p>
</article>
</div> <!-- end gi1 -->
<aside class="gi2">
<ul>
<strong>2019</strong><li>7 Jun <a href="index.html?p=778">plkt.io</a></li><li>29 May <a href="index.html?p=774">Using Amplify to launch your first Gatsby app</a></li><li>29 May <a href="index.html?p=768">Immediate broken pipe when connecting via SSH on Gentoo under VMWare Fusion</a></li><li>22 Apr <a href="index.html?p=754">Debugging ebuild failure on Gentoo for lxml</a></li><li>17 Apr <a href="index.html?p=749">Git up and going</a></li><li>29 Mar <a href="index.html?p=741">Using GPG to master your identity (Part 1)</a></li><li>23 Mar <a href="index.html?p=727">Moving a user cron job to a systemd timer</a></li><li>4 Mar <a href="index.html?p=723">Building plkt.io</a></li><li>21 Feb <a href="index.html?p=714">VLAN Primer</a></li><li>6 Feb <a href="index.html?p=707">Creating a disposable dev environment using libvirt</a></li><li>21 Jan <a href="index.html?p=700">Selectively applying changes with Git Stash</a></li><li>9 Jan <a href="index.html?p=690">2019 Goals and Tentatives</a></li><li>4 Jan <a href="index.html?p=680">Fresh Ubuntu 18.04 Install</a></li><li>3 Jan <a href="index.html?p=675">Quickly setting up a local Tiny Tiny RSS instance with Docker</a></li><br /><strong>2018</strong><li>20 Dec <a href="index.html?p=630">Generating smooth sine tone output on iOS</a></li><li>14 Dec <a href="index.html?p=626">Installing Jupyter on macOS Mojave</a></li><li>28 Nov <a href="index.html?p=602">ifconfig Output on macOS Mojave</a></li><li>23 Nov <a href="index.html?p=598">Setting up macOS Mojave</a></li><li>21 Nov <a href="index.html?p=582">Setting up a Docker Pi-hole DNS server for wired and wireless clients</a></li><li>13 May <a href="index.html?p=663">Understanding SHA256 Part 3</a></li><li>12 May <a href="index.html?p=662">Understanding SHA256 Part 2</a></li><li>11 May <a href="index.html?p=661">Understanding SHA256 Part 1</a></li><li>1 Apr <a href="index.html?p=622">Demoscene</a></li><li>1 Jan <a href="index.html?p=624">Running a Bitcoin node</a></li><br /><strong>2016</strong><li>21 Oct <a href="index.html?p=576">Hosting my own blog</a></li><li>4 Aug <a href="index.html?p=544">Creating a video montage with ffmpeg</a></li><br /><strong>2015</strong><li>27 Dec <a href="index.html?p=524">Cloning Logical Volumes on Linux</a></li><li>29 Aug <a href="index.html?p=520">Google public WiFI</a></li><li>29 Aug <a href="index.html?p=508">Arch Linux on Dell M6800</a></li><li>20 Jul <a href="index.html?p=429">iOS 9 Public Beta 1 Changes</a></li><li>19 Apr <a href="index.html?p=492">PDF Minimalist 2015 Calendar for Printing</a></li><br /><strong>2013</strong><li>1 Apr <a href="index.html?p=484">Setting up a git server accessible via ssh</a></li><br /><strong>2012</strong><li>13 Apr <a href="index.html?p=424">Google&#039;s addition of C class stock</a></li><li>1 Mar <a href="index.html?p=405">Backing up your Gmail account using procmail and fetchmail</a></li><li>26 Jan <a href="index.html?p=396">Quickly Attaching USB Devices to VirtualBox Guests using VBoxManage</a></li><br /><strong>2011</strong><li>2 Jun <a href="index.html?p=389">Predictions for iOS 5</a></li><li>10 Feb <a href="index.html?p=385">HP Veer</a></li><br /><strong>2010</strong><li>1 May <a href="index.html?p=378">Getting Started with Symbian Development</a></li><br /><strong>2009</strong><li>2 Nov <a href="index.html?p=373">Printing to a remote printer</a></li><li>10 Sep <a href="index.html?p=369">KDE DPI Issue</a></li><li>22 Aug <a href="index.html?p=365">Sony NWZ-E438F + Video</a></li><li>11 Aug <a href="index.html?p=361">Movies for August 2009</a></li><li>26 Jul <a href="index.html?p=356">Readline</a></li><li>18 Jul <a href="index.html?p=347">Installing Windows XP in VirtualBox</a></li><li>16 Jul <a href="index.html?p=338">Looking Good&#8230;Minimally</a></li><li>3 Jul <a href="index.html?p=335">FreeBSD and Arch Linux</a></li><li>27 Jun <a href="index.html?p=332">Using your Gmail contacts in Mutt</a></li><li>27 Jun <a href="index.html?p=331">Recent Microsoft Developments</a></li><li>25 Jun <a href="index.html?p=318">Budget Intel Gaming Rig ($500)</a></li><li>15 Jun <a href="index.html?p=325">A tired mind cannot comprehend pointer arithmetic</a></li><li>14 Jun <a href="index.html?p=232">Managing gpg keys across multiple computers</a></li><li>1 Jun <a href="index.html?p=313">Elinks advanced URI management</a></li><li>26 May <a href="index.html?p=311">xf86-video-intel-2.6.3 and xorg-server-1.6.1 &#8230; a big fail</a></li><li>24 May <a href="index.html?p=204">Install a GNU/Linux distribution upon a USB Stick</a></li><li>29 Apr <a href="index.html?p=260">Squashing the PITA!</a></li><br /><strong>2008</strong><li>16 Dec <a href="index.html?p=243">Atomicity</a></li><li>16 Dec <a href="index.html?p=247">Changing the default X11 Cursor</a></li><li>9 Dec <a href="index.html?p=238">Using xbindkeys to manage media buttons</a></li><li>8 Dec <a href="index.html?p=242">xf86-video-intel-2.4.3</a></li><li>15 Nov <a href="index.html?p=234">Compiling 2.6.27.6 using the vanilla kernel tree sources</a></li><li>10 Nov <a href="index.html?p=215">MigrationHeuristic</a></li><li>28 Oct <a href="index.html?p=195">Arch Linux and the HP Compaq 2710p</a></li><li>18 Oct <a href="index.html?p=187">Setting up IMAP on Mutt</a></li><li>7 Oct <a href="index.html?p=152">Managing your wireless connection with Wireless Tools for Linux</a></li><li>19 Aug <a href="index.html?p=177">Upgrading to linux-2.6.27-rc3</a></li><li>10 Aug <a href="index.html?p=146">Automatically logout after X is killed</a></li><li>9 Aug <a href="index.html?p=129">Upgrading to catalyst-8.7</a></li><li>8 Aug <a href="index.html?p=123">Upgrading to linux-2.6.27-rc2</a></li><li>4 Aug <a href="index.html?p=106">Upgrading to linux-2.6.27-rc1</a></li><li>1 Aug <a href="index.html?p=86">Customising Email Signatures with Fortune</a></li><li>28 Jul <a href="index.html?p=85">Time Saving Vim Movement Tips</a></li><li>20 Jul <a href="index.html?p=53">Configuring the default prompt (PS1)</a></li><li>15 Jul <a href="index.html?p=45">Adding additional email accounts to your email setup</a></li><li>12 Jul <a href="index.html?p=47">Setting up Mutt</a></li><li>8 Jul <a href="index.html?p=28">Making Diagrams with Xy-pic</a></li><li>7 Jul <a href="index.html?p=26">Changing The Default X Cursor</a></li><li>6 Jul <a href="index.html?p=24">My Desktop &#8211; The Terminal</a></li><li>30 Jun <a href="index.html?p=18">My Desktop &#8211; Music</a></li><li>28 Jun <a href="index.html?p=15">My Desktop &#8211; The Web</a></li><li>26 Jun <a href="index.html?p=8">My Desktop</a></li><li>25 Jun <a href="index.html?p=79">Rationale</a></li></ul> 
</aside>
<footer class="gi3">
<hr />
&copy; 2008 &mdash; 2018 Xocite
</footer>
</div> <!-- end gc -->
</body>
</html>
