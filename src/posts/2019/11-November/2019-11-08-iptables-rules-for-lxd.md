---
path: "/writing/iptables-lxd"
date: "2019-11-08"
title: "IPTables rules for LXD"
commentary: false
attract: "LXD and IPTables can coexist."
---
I recently had a lot of difficultly working out how to get ufw (the uncomplicated firewall) to work with LXD Linux containers.

Because of all the issues and me not having a lot of time to dig deep into the tool, I decided to revisit some of my old iptables configs and amend them to work with LXD.

# Some disclaimers
I do want to note that these rules work for me but are not really any guarantee against being attacked, hacked, monitored, MITMed, or <insert-bad-thing-here>.  For me they act as reasonable defense against basic attacks.  For a really important web facing box I'd recommend placing a CDN in front of it and routing traffic through the CDN or alternatively using something like Argo Tunnel and only allowing connections through Argo.

# A bit of reading
Here are the notes I reviewed before authoring this post.  I think they serve as good background for iptables and can be skipped at your own peril :).

Looking at the manpage for iptables we have five built-in tables and each of these contain some chains.  These notes are pulled directly from `man iptables` but I felt serve as a good overview of some of these tables.

* filter: the default table
  * input: for packets destined to local sockets
  * forward: for packets being routed through the box
  * output: for locally-generated packets
* nat: consulted when a new packet is encounted
  * prerouting: for altering packets as soon as they arrive
  * input: for altering packets destined for local sockets
  * output: for altering locally-generated packets before routing
  * postrouting: for altering packets as they are about to go out
* mangle: specialised packet alteration
  * prerouting: for altering incoming packets before routing
  * postrouting: for altering packets being routed through the box
* raw: configuring exemption from connection tracking
  * prerouting: for packets arriving via any network interface)
  * postrouting: for packets generated by local processes
* security: used for mandatory access control rules
  * input: for packets coming into the box itself
  * output: for altering locally-generated packets before routing
  * forward: for altering packets being routed through the box

For command line invocation, we'll be using the following.  The long name is appended to the command line with double dash (--) and the single letter is the abbreviated call with a single dash.  <> are required parameters [] are optional.
* append(A) <chain> <rule-specification> add one or more rules to the end of the selected chain
* check(C) <chain> <rule-specification> check whether a rule matching the specification does exist in the selected chain
* insert(I) <chain> [rulenum] <rule-specification> insert one or more rules in the selected chain as the given rule number.  If no rulenum specified, default to rulenum as 1 (inserted at the head/top/front of the chain).
* list(L) [chain] lists the rules
* new-chain(N) <chain> create a new chain

# Stateful firewall
## Default rules
These are the default rules to lock down the box for access from a single IP.

First we load the conntrack modules to enable the stateful firewall.
```
# modprobe ip_conntrack
# modprobe ip_conntrack_ftp
```

Then we create a new chain to host the rules and add the rules to that chain.  These rules block forwarding from one interface to another; allow all outbound traffic.  Then we add an exception to our IP and then drop all incoming traffic otherwise.  Next we allow all inbound ongoing connections to work as intended.
```
iptables -N custom-rules
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT
iptables -P INPUT DROP
iptables -A FORWARD -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
iptables -A INPUT -s <your_ip_address> -j ACCEPT
```

```
```

After you already have the base of LXD configured, create the network bridge and configure the NAT gateway.

# Additional notes




```
```

```
```

```
```

```
```

```
```


