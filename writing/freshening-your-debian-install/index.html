<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.3d290c5a692c5c053dca.css">.navigation-module--navbar--c_Ttk{margin:0;padding-left:1rem}.navigation-module--navbar--c_Ttk ul{list-style-type:none}.navigation-module--navbar--c_Ttk li{display:inline-flex;padding-right:10px}@media only screen and (max-width:480px){.navigation-module--navbar--c_Ttk{padding-left:0}}.header-module--container--18lpt{margin:0 auto;max-width:960px;padding:1.45rem 1.0875rem;display:flex;justify-content:flex-start;align-items:center}@media only screen and (max-width:480px){.header-module--container--18lpt{display:block}}.header-module--logo--3gu8x{padding-right:10px}html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects;text-decoration:none}a:active,a:hover{outline-width:0;text-decoration:underline}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:90%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:.9em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:100%/1.45em sans-serif;box-sizing:border-box;overflow-y:scroll}*,:after,:before{box-sizing:inherit}body{color:rgba(0,0,0,.8);font-family:Helvetica Neue,Helvetica,Arial,sans-serif;font-weight:400;word-wrap:break-word;-webkit-font-kerning:normal;font-kerning:normal;-ms-font-feature-settings:"kern","liga","clig","calt";font-feature-settings:"kern","liga","clig","calt"}img{max-width:100%;padding:0;margin:0}h1{margin:0 0 1rem;font-size:2.25rem}h1,h2{padding:0;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h2{margin:0 0 1.45rem;font-size:1.62671rem}h3{font-size:1.38316rem}h3,h4{padding:0;margin:0 0 1.45rem;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h4{font-size:1rem}h5{font-size:.85028rem}h5,h6{padding:0;margin:0 0 1.45rem;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h6{font-size:.78405rem}hgroup{padding:0;margin:0 0 1.45rem}ol,ul{padding:0;margin:0 0 1.45rem 1.45rem;list-style-position:outside;list-style-image:none}dd,dl,figure,p{padding:0;margin:0 0 1.45rem}pre{margin:0 0 1.45rem;font-size:.85rem;line-height:1.42;background:rgba(0,0,0,.04);border-radius:3px;overflow:auto;word-wrap:normal;padding:1.45rem}table{font-size:1rem;line-height:1.45rem;border-collapse:collapse;width:100%}fieldset,table{padding:0;margin:0 0 1.45rem}blockquote{padding:0;margin:0 1.45rem 1.45rem}form,iframe,noscript{padding:0;margin:0 0 1.45rem}hr{padding:0;margin:0 0 calc(1.45rem - 1px);background:rgba(0,0,0,.2);border:none;height:1px}address{padding:0;margin:0 0 1.45rem}b,dt,strong,th{font-weight:700}li{margin-bottom:.725rem}ol li,ul li{padding-left:0}li>ol,li>ul{margin-left:1.45rem;margin-bottom:.725rem;margin-top:.725rem}blockquote :last-child,li :last-child,p :last-child{margin-bottom:0}li>p{margin-bottom:.725rem}code,kbd,samp{font-size:.85rem;line-height:1.45rem}abbr,abbr[title],acronym{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help}abbr[title]{text-decoration:none}td,th,thead{text-align:left}td,th{border-bottom:1px solid rgba(0,0,0,.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding:.725rem .96667rem calc(.725rem - 1px)}td:first-child,th:first-child{padding-left:0}td:last-child,th:last-child{padding-right:0}code,tt{background-color:rgba(0,0,0,.04);border-radius:3px;font-family:SFMono-Regular,Consolas,Roboto Mono,Droid Sans Mono,Liberation Mono,Menlo,Courier,monospace;padding:.2em 0}pre code{background:none;line-height:1.42}code:after,code:before,tt:after,tt:before{letter-spacing:-.2em;content:" "}pre code:after,pre code:before,pre tt:after,pre tt:before{content:""}@media only screen and (max-width:480px){html{font-size:100%}}code[class*=language-],pre[class*=language-]{color:#657b83;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:12px;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.1;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{background:#073642}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em}:not(pre)>code[class*=language-],pre[class*=language-]{background-color:#fdf6e3}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#93a1a1}.token.punctuation{color:#586e75}.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#268bd2}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string,.token.url{color:#2aa198}.token.entity{color:#657b83;background:#eee8d5}.token.atrule,.token.attr-value,.token.keyword{color:#859900}.token.class-name,.token.function{color:#b58900}.token.important,.token.regex,.token.variable{color:#cb4b16}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.layout-module--container--zLeA4{margin:0 auto;max-width:960px;padding:0 1.0875rem 1.45rem}</style><meta name="generator" content="Gatsby 2.17.15"/><title data-react-helmet="true">Refreshing your Debian install with debootstrap and LVM | Antony Jepson</title><meta data-react-helmet="true" name="description" content="The best way to see and get involved in what Antony Jepson is doing."/><meta data-react-helmet="true" property="og:title" content="Refreshing your Debian install with debootstrap and LVM"/><meta data-react-helmet="true" property="og:description" content="The best way to see and get involved in what Antony Jepson is doing."/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="@plktio"/><meta data-react-helmet="true" name="twitter:title" content="Refreshing your Debian install with debootstrap and LVM"/><meta data-react-helmet="true" name="twitter:description" content="The best way to see and get involved in what Antony Jepson is doing."/><style type="text/css">.gatsby-resp-image-image{width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;color:transparent;}</style><style type="text/css">.gatsby-resp-image-image{width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;color:transparent;}</style><link as="script" rel="preload" href="/styles-d3a33cdbd079d52aea66.js"/><link as="script" rel="preload" href="/component---src-templates-blog-template-js-81ea185a68025d8f344b.js"/><link as="script" rel="preload" href="/commons-06cb1af88dd52fc7edab.js"/><link as="script" rel="preload" href="/app-5e8e3403a0a9ffb56daa.js"/><link as="script" rel="preload" href="/webpack-runtime-bbbf6406194f21da6d7e.js"/><link as="fetch" rel="preload" href="/page-data/writing/freshening-your-debian-install/page-data.json" crossorigin="anonymous"/><link rel="shortcut icon" type="image/png" href="/static/favicon-cf2918cfc80826d63260e0202f2aa871.ico"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group" id="gatsby-focus-wrapper"><header><div class="header-module--container--18lpt"><a href="/"><img class="header-module--logo--3gu8x" src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAYABgAAD/4QCMRXhpZgAATU0AKgAAAAgABQESAAMAAAABAAEAAAEaAAUAAAABAAAASgEbAAUAAAABAAAAUgEoAAMAAAABAAIAAIdpAAQAAAABAAAAWgAAAAAAAABgAAAAAQAAAGAAAAABAAOgAQADAAAAAQABAACgAgAEAAAAAQAAAECgAwAEAAAAAQAAAEAAAAAA/+0AOFBob3Rvc2hvcCAzLjAAOEJJTQQEAAAAAAAAOEJJTQQlAAAAAAAQ1B2M2Y8AsgTpgAmY7PhCfv/AABEIAEAAQAMBIgACEQEDEQH/xAAfAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgv/xAC1EAACAQMDAgQDBQUEBAAAAX0BAgMABBEFEiExQQYTUWEHInEUMoGRoQgjQrHBFVLR8CQzYnKCCQoWFxgZGiUmJygpKjQ1Njc4OTpDREVGR0hJSlNUVVZXWFlaY2RlZmdoaWpzdHV2d3h5eoOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4eLj5OXm5+jp6vHy8/T19vf4+fr/xAAfAQADAQEBAQEBAQEBAAAAAAAAAQIDBAUGBwgJCgv/xAC1EQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2wBDAAICAgICAgMCAgMEAwMDBAUEBAQEBQcFBQUFBQcIBwcHBwcHCAgICAgICAgKCgoKCgoLCwsLCw0NDQ0NDQ0NDQ3/2wBDAQICAgMDAwYDAwYNCQcJDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ3/3QAEAAT/2gAMAwEAAhEDEQA/AP2Iooor/AM/VAooooAKKKKACiiigD//0P2Ioo+b0NHzehr/AAG9nLsfql0FFHzeho+b0NHs5dgugoo+b0NHzeho9nLsF0FFHzeho+b0NHs5dguj/9H5E/4Rjw1/0B9P/wDAWL/4mj/hGPDX/QH0/wD8BYv/AImtuiv9gPrdf+d/ez4blXYxP+EY8Nf9AfT/APwFi/8AiaP+EY8Nf9AfT/8AwFi/+Jrboo+t1/5397DlXYxP+EY8Nf8AQH0//wABYv8A4mj/AIRjw1/0B9P/APAWL/4mtuij63X/AJ397DlXYxP+EY8Nf9AfT/8AwFi/+Jo/4Rjw1/0B9P8A/AWL/wCJrboo+t1/5397DlXY/9L5foqf7Ldf88Zf++G/wo+y3X/PGX/vhv8ACv8AXbnj3PiLMgoqf7Ldf88Zf++G/wAKPst1/wA8Zf8Avhv8KOePcLMgoqf7Ldf88Zf++G/wo+y3X/PGX/vhv8KOePcLMgoqf7Ldf88Zf++G/wAKPst1/wA8Zf8Avhv8KOePcLM//9k=" alt="plkt.io logo"/></a><h1><a href="/">Antony Jepson</a></h1><nav class="navigation-module--navbar--c_Ttk"><ul class="navigation-module--navbar--c_Ttk"><li><a href="/about"> <!-- -->🤔 About<!-- --> </a></li><li><a href="/bookshelf"> <!-- -->📚 Bookshelf<!-- --> </a></li><li><a href="/contact"> <!-- -->✍️ Contact and Employment<!-- --> </a></li><li><a href="/links"> <!-- -->🔗 Links<!-- --> </a></li></ul></nav></div></header><div class="layout-module--container--zLeA4"><main><div class="blog-post-container"><div class="blog-post"><h1>Refreshing your Debian install with debootstrap and LVM</h1> Published » <!-- -->2019-11-17<br/><br/><div class="blog-post-content"><p>I must admit I'm quite jealous of Windows' ability to "refresh" meaning return it to a near vanilla state with a click of a button.  I've always had a brief moment of horror when thinking about how to refresh my Debian install and have it work the first time, especially with the various configurations you can have with LUKS on LVM and a separate /boot partition.</p>
<p>That being said, I have too much cruft on my home server's install with old docker binaries laying around, various extra bridges brought in by libvirt and even minikube and k3s managing to become deeply intertwined with systemd somehow.</p>
<p>So I wanted to start with a fresh Debian 10.2 install that would replace my existing install and work the first time upon rebooting (a large ask!).</p>
<h1>Background</h1>
<p>My setup on the home server is pretty simple.  A 60GB root drive that runs ext4 on LVM.  No LUKS here because it's a headless server that doesn't have a keyboard attached.  /home partition could be encrypted but that's an exercise for another day?  Asking me why I don't encrypt this drive is like saying why don't you encrypt your Raspberry Pi's SD card?  It just seems like something that's going to cause pain for little reason.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Disk /dev/sda: 55.9 GiB, 60022480896 bytes, 117231408 sectors

Device       Start       End   Sectors  Size Type
/dev/sda1     2048   1050623   1048576  512M EFI System
/dev/sda2  1050624   1550335    499712  244M Linux filesystem
/dev/sda3  1550336 117229567 115679232 55.2G Linux LVM</code></pre></div>
<p>The plan is to create a new Debian partition with LVM, run debootstrap into it, chroot, set up SSH remote access by copying the config over from the old install.</p>
<h1>Preparing LVM</h1>
<p>As with any major operation, we should snapshot our current state so we can restore if things don't go well.  However, because the change is taking place in a new logical volume we can simply leave the old LV untouched.</p>
<p>First we'll backup the LVM headers for physical volumes, volume groups, and logical volumes.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">tar cf /somewhere/away/from/lvm/lvm.tar /etc/lvm</code></pre></div>
<p>Next we'll backup the boot partition</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">umount /boot
mount -o ro /boot
tar cf /somewhere/away/from/lvm/boot.tar /boot</code></pre></div>
<p>Finally, we create the new logical volume to house the new installation.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">lvcreate -L 4G -n newroot volumegroup</code></pre></div>
<h1>Creating the new Debian partition</h1>
<p>This part was made easy thanks to Debian's really useful tools.  More information available in their <a href="https://www.debian.org/releases/stretch/amd64/apds03.html.en">Developer Documentation</a>.  Install debootstrap if you don't already have it and walk through the following commands on the target machine.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">mkfs.ext4 /dev/mapper/volumegroup-newroot 
mkdir /mnt/debian
mount /dev/mapper/volumegroup-newroot /mnt/debian
/usr/sbin/debootstrap --arch amd64 buster /mnt/debian http://ftp.us.debian.org/debian
mount --rbind /dev /mnt/debian/dev
mount --make-rslave /mnt/debian/dev
mount -t proc /proc /mnt/debian/proc
mount --rbind /sys /mnt/debian/sys
mount --make-rslave /mnt/debian/sys
mount --rbind /tmp /mnt/debian/tmp 
cp /etc/fstab /mnt/debian/etc/fstab
vim /mnt/debian/etc/fstab # change root to point to newroot
cp /etc/adjtime /mnt/debian/etc/adjtime
cp /etc/hosts /mnt/debian/etc/hosts
cp /etc/hostname /mnt/debian/etc/hostname
cp /etc/network/interfaces /mnt/debian/etc/network/
cp /etc/resolv.conf /mnt/debian/etc/resolv.conf
cat /etc/apt/sources.list &gt;&gt; /mnt/debian/etc/apt/sources.list
vim /mnt/debian/etc/apt/sources.list # fix any errors
LANG=C.UTF-8 chroot /mnt/debian /bin/bash
(inside chroot) apt update
(inside chroot) dpkg-reconfigure tzdata
(inside chroot) mount /boot
(inside chroot) apt install linux-image-4.19.0-6-amd64
(inside chroot) apt install grub2 # don&#39;t select to install to any partition
(inside chroot) apt install lvm2
(inside chroot) apt install ssh
(inside chroot) systemctl enable ssh
(inside chroot) editor /etc/ssh/sshd_config # set PermitRootLogin yes
(inside chroot) adduser local
(inside chroot) passwd local
(inside chroot) passwd # set root passwd</code></pre></div>
<p>Now the system is completely configured for booting.  You'll need to check /boot/grub/grub.cfg and make sure that the newroot LVM ID is referenced (use lvdisplay).</p>
<p>Reboot the system.  If it doesn't work, you'll likely need to get out your external monitor and external keyboard.  Luckily, I survived unharmed :).</p>
<h1>Finishing touches</h1>
<p>SSH into the new system as root and finish installing the standard system files.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">tasksel install standard</code></pre></div>
<p>Don't forget to delete the old entry in your local machine's sshd config as new keys were generated for the new install.</p>
<p>You can remove the old LVM logical volume or use it to bring over any missing configuration from the new install.</p>
<p>And with that, consider your Debian install refreshed!</p></div></div></div></main><footer><small><br/><hr/>Built with<!-- --> <a href="https://www.gatsbyjs.org">Gatsby</a>,<!-- --> <a href="https://code.visualstudio.com/">VSCode</a>,<!-- --> <a href="https://www.gentoo.org">Gentoo</a>,<!-- --> <a href="https://aws.amazon.com/amplify/">Amplify</a>,<!-- --> and <a href="https://reactjs.org/">React</a><br/>© 2008 to <!-- -->2019<!-- --> Antony Jepson <div><a href=""></a></div></small></footer></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/writing/freshening-your-debian-install";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-5e8e3403a0a9ffb56daa.js"],"component---src-templates-blog-template-js":["/component---src-templates-blog-template-js-81ea185a68025d8f344b.js"],"component---src-pages-404-js":["/component---src-pages-404-js-c433172558af0ec619d8.js"],"component---src-pages-bookshelf-js":["/component---src-pages-bookshelf-js-a6f46bdd8197de05d2da.js"],"component---src-pages-contact-js":["/component---src-pages-contact-js-64cc8d6d66f221cedd71.js"],"component---src-pages-index-js":["/component---src-pages-index-js-abbda385227ec532f3ac.js"]};/*]]>*/</script><script src="/webpack-runtime-bbbf6406194f21da6d7e.js" async=""></script><script src="/app-5e8e3403a0a9ffb56daa.js" async=""></script><script src="/commons-06cb1af88dd52fc7edab.js" async=""></script><script src="/component---src-templates-blog-template-js-81ea185a68025d8f344b.js" async=""></script><script src="/styles-d3a33cdbd079d52aea66.js" async=""></script><noscript id="gatsby-noscript">JavaScript makes my website work better but I&#x27;ve made sure you can still have an enjoyable experience without it.</noscript></body></html>