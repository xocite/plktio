<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/commons.8ab94fb6c1d149f6ae2d.css">.navigation-module--navbar--c_Ttk{margin:0;padding-left:1rem}.navigation-module--navbar--c_Ttk ul{list-style-type:none}.navigation-module--navbar--c_Ttk li{display:inline-flex;padding-right:10px}@media only screen and (max-width:480px){.navigation-module--navbar--c_Ttk{padding-left:0}}.header-module--container--18lpt{margin:0 auto;max-width:960px;padding:1.45rem 1.0875rem;display:flex;justify-content:flex-start;align-items:center}@media only screen and (max-width:480px){.header-module--container--18lpt{display:block}}.header-module--logo--3gu8x{padding-right:10px}html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects;text-decoration:none}a:active,a:hover{outline-width:0;text-decoration:underline}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:90%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:.9em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:100%/1.45em sans-serif;box-sizing:border-box;overflow-y:scroll}*,:after,:before{box-sizing:inherit}body{color:rgba(0,0,0,.8);font-family:Helvetica Neue,Helvetica,Arial,sans-serif;font-weight:400;word-wrap:break-word;-webkit-font-kerning:normal;font-kerning:normal;-ms-font-feature-settings:"kern","liga","clig","calt";font-feature-settings:"kern","liga","clig","calt"}img{max-width:100%;padding:0;margin:0}h1{margin:0 0 1rem;font-size:2.25rem}h1,h2{padding:0;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h2{margin:0 0 1.45rem;font-size:1.62671rem}h3{font-size:1.38316rem}h3,h4{padding:0;margin:0 0 1.45rem;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h4{font-size:1rem}h5{font-size:.85028rem}h5,h6{padding:0;margin:0 0 1.45rem;color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h6{font-size:.78405rem}hgroup{padding:0;margin:0 0 1.45rem}ol,ul{padding:0;margin:0 0 1.45rem 1.45rem;list-style-position:outside;list-style-image:none}dd,dl,figure,p{padding:0;margin:0 0 1.45rem}pre{margin:0 0 1.45rem;font-size:.85rem;line-height:1.42;background:rgba(0,0,0,.04);border-radius:3px;overflow:auto;word-wrap:normal;padding:1.45rem}table{font-size:1rem;line-height:1.45rem;border-collapse:collapse;width:100%}fieldset,table{padding:0;margin:0 0 1.45rem}blockquote{padding:0;margin:0 1.45rem 1.45rem}form,iframe,noscript{padding:0;margin:0 0 1.45rem}hr{padding:0;margin:0 0 calc(1.45rem - 1px);background:rgba(0,0,0,.2);border:none;height:1px}address{padding:0;margin:0 0 1.45rem}b,dt,strong,th{font-weight:700}li{margin-bottom:.725rem}ol li,ul li{padding-left:0}li>ol,li>ul{margin-left:1.45rem;margin-bottom:.725rem;margin-top:.725rem}blockquote :last-child,li :last-child,p :last-child{margin-bottom:0}li>p{margin-bottom:.725rem}code,kbd,samp{font-size:.85rem;line-height:1.45rem}abbr,abbr[title],acronym{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help}abbr[title]{text-decoration:none}td,th,thead{text-align:left}td,th{border-bottom:1px solid rgba(0,0,0,.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding:.725rem .96667rem calc(.725rem - 1px)}td:first-child,th:first-child{padding-left:0}td:last-child,th:last-child{padding-right:0}code,tt{background-color:rgba(0,0,0,.04);border-radius:3px;font-family:SFMono-Regular,Consolas,Roboto Mono,Droid Sans Mono,Liberation Mono,Menlo,Courier,monospace;padding:.2em 0}pre code{background:none;line-height:1.42}code:after,code:before,tt:after,tt:before{letter-spacing:-.2em;content:" "}pre code:after,pre code:before,pre tt:after,pre tt:before{content:""}@media only screen and (max-width:480px){html{font-size:100%}}code[class*=language-],pre[class*=language-]{color:#657b83;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:12px;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.1;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::-moz-selection,code[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection{background:#073642}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{background:#073642}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em}:not(pre)>code[class*=language-],pre[class*=language-]{background-color:#fdf6e3}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#93a1a1}.token.punctuation{color:#586e75}.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#268bd2}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string,.token.url{color:#2aa198}.token.entity{color:#657b83;background:#eee8d5}.token.atrule,.token.attr-value,.token.keyword{color:#859900}.token.class-name,.token.function{color:#b58900}.token.important,.token.regex,.token.variable{color:#cb4b16}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.layout-module--container--zLeA4{margin:0 auto;max-width:960px;padding:0 1.0875rem 1.45rem}</style><meta name="generator" content="Gatsby 2.15.28"/><title data-react-helmet="true">Configuring and integrating Nitrokey into your workflow | Antony Jepson</title><meta data-react-helmet="true" name="description" content="The best way to see and get involved in what Antony Jepson is doing."/><meta data-react-helmet="true" property="og:title" content="Configuring and integrating Nitrokey into your workflow"/><meta data-react-helmet="true" property="og:description" content="The best way to see and get involved in what Antony Jepson is doing."/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="@plktio"/><meta data-react-helmet="true" name="twitter:title" content="Configuring and integrating Nitrokey into your workflow"/><meta data-react-helmet="true" name="twitter:description" content="The best way to see and get involved in what Antony Jepson is doing."/><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><style type="text/css">.gatsby-resp-image-image{width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;color:transparent;}</style><style type="text/css">.gatsby-resp-image-image{width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;color:transparent;}</style><link as="script" rel="preload" href="/app-010e7023b2ceb6cc2e86.js"/><link as="script" rel="preload" href="/component---src-templates-blog-template-js-1bb93a169f96d271cd24.js"/><link as="script" rel="preload" href="/commons-fa205ddb4d04c9cc16a5.js"/><link as="script" rel="preload" href="/webpack-runtime-1ae3d3dba2dc090e4602.js"/><link as="fetch" rel="preload" href="/page-data/writing/integrating-nitrokey/page-data.json" crossorigin="anonymous"/><link rel="shortcut icon" type="image/png" href="/static/favicon-cf2918cfc80826d63260e0202f2aa871.ico"/></head><body><noscript id="gatsby-noscript">This app works best with JavaScript enabled.</noscript><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group" id="gatsby-focus-wrapper"><header><div class="header-module--container--18lpt"><a href="/"><img class="header-module--logo--3gu8x" src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAYABgAAD/4QCMRXhpZgAATU0AKgAAAAgABQESAAMAAAABAAEAAAEaAAUAAAABAAAASgEbAAUAAAABAAAAUgEoAAMAAAABAAIAAIdpAAQAAAABAAAAWgAAAAAAAABgAAAAAQAAAGAAAAABAAOgAQADAAAAAQABAACgAgAEAAAAAQAAAECgAwAEAAAAAQAAAEAAAAAA/+0AOFBob3Rvc2hvcCAzLjAAOEJJTQQEAAAAAAAAOEJJTQQlAAAAAAAQ1B2M2Y8AsgTpgAmY7PhCfv/AABEIAEAAQAMBIgACEQEDEQH/xAAfAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgv/xAC1EAACAQMDAgQDBQUEBAAAAX0BAgMABBEFEiExQQYTUWEHInEUMoGRoQgjQrHBFVLR8CQzYnKCCQoWFxgZGiUmJygpKjQ1Njc4OTpDREVGR0hJSlNUVVZXWFlaY2RlZmdoaWpzdHV2d3h5eoOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4eLj5OXm5+jp6vHy8/T19vf4+fr/xAAfAQADAQEBAQEBAQEBAAAAAAAAAQIDBAUGBwgJCgv/xAC1EQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2wBDAAICAgICAgMCAgMEAwMDBAUEBAQEBQcFBQUFBQcIBwcHBwcHCAgICAgICAgKCgoKCgoLCwsLCw0NDQ0NDQ0NDQ3/2wBDAQICAgMDAwYDAwYNCQcJDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ3/3QAEAAT/2gAMAwEAAhEDEQA/AP2Iooor/AM/VAooooAKKKKACiiigD//0P2Ioo+b0NHzehr/AAG9nLsfql0FFHzeho+b0NHs5dgugoo+b0NHzeho9nLsF0FFHzeho+b0NHs5dguj/9H5E/4Rjw1/0B9P/wDAWL/4mj/hGPDX/QH0/wD8BYv/AImtuiv9gPrdf+d/ez4blXYxP+EY8Nf9AfT/APwFi/8AiaP+EY8Nf9AfT/8AwFi/+Jrboo+t1/5397DlXYxP+EY8Nf8AQH0//wABYv8A4mj/AIRjw1/0B9P/APAWL/4mtuij63X/AJ397DlXYxP+EY8Nf9AfT/8AwFi/+Jo/4Rjw1/0B9P8A/AWL/wCJrboo+t1/5397DlXY/9L5foqf7Ldf88Zf++G/wo+y3X/PGX/vhv8ACv8AXbnj3PiLMgoqf7Ldf88Zf++G/wAKPst1/wA8Zf8Avhv8KOePcLMgoqf7Ldf88Zf++G/wo+y3X/PGX/vhv8KOePcLMgoqf7Ldf88Zf++G/wAKPst1/wA8Zf8Avhv8KOePcLM//9k=" alt="plkt.io logo"/></a><h1><a href="/">Antony Jepson</a></h1><nav class="navigation-module--navbar--c_Ttk"><ul class="navigation-module--navbar--c_Ttk"><li><a href="/about"> <!-- -->🤔 About<!-- --> </a></li><li><a href="/bookshelf"> <!-- -->📚 Bookshelf<!-- --> </a></li><li><a href="/contact"> <!-- -->✍️ Contact and Employment<!-- --> </a></li><li><a href="/links"> <!-- -->🔗 Links<!-- --> </a></li></ul></nav></div></header><div class="layout-module--container--zLeA4"><main><div class="blog-post-container"><div class="blog-post"><h1>Configuring and integrating Nitrokey into your workflow</h1>Updated » 2019-08-09 |<!-- --> Published » <!-- -->2019-07-30<br/><br/><div class="blog-post-content"><p><em>Keywords: ssh-agent, gpg-agent, pcsc, nitrokey</em></p>
<p>I recently collected a new <a href="https://www.nitrokey.com/">Nitrokey Pro</a>.  This post
explains how I configured it and integrated it into my authentication flow.</p>
<h1>Before connecting the Nitrokey</h1>
<p>The Nitrokey supports the OpenPGP standard so you'll be mainly interacting with
it using GPG. On Gentoo Linux, you'll need gnupg with the +smartcard and +usb USE flags
enabled.</p>
<p><code class="language-text"># echo &quot;app-crypt/gnupg smartcard usb&quot; &gt;&gt; /etc/portage/package.use/gnupg</code></p>
<p>Next, we'll install the required packages.</p>
<p><code class="language-text">$ sudo emerge -av sys-apps/pcsc-tools sys-apps/pcsc-lite dev-libs/opensc \
app-crypt/ccid app-crypt/gnupg</code></p>
<p>The abstractions work like the following: gnupg -> pcsc-lite -> opensc -> ccid
-> nitrokey.</p>
<h1>Connecting the Nitrokey</h1>
<p>Here's the immediate output from <code class="language-text">dmesg</code> after connecting the Nitrokey.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">[24798.012187] usb 2-2.2: new full-speed USB device number 5 using uhci_hcd
[24798.450042] usb 2-2.2: New USB device found, idVendor=20a0, idProduct=4108,
bcdDevice= 1.01
[24798.450044] usb 2-2.2: New USB device strings: Mfr=1, Product=2,
SerialNumber=3
[24798.450046] usb 2-2.2: Product: Nitrokey Pro
[24798.450047] usb 2-2.2: Manufacturer: Nitrokey
[24798.450048] usb 2-2.2: SerialNumber: 0000000000000000000086BE
[24798.467777] hid-generic 0003:20A0:4108.0002: hiddev96,hidraw1: USB HID v1.10
Device [Nitrokey Nitrokey Pro] on usb-0000:02:00.0-2.2/input0</code></pre></div>
<p>Let's see if pcsc supports the smart card.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">$ sudo pcscd -a -d -f
[..snip..]
00005549 /var/tmp/portage/sys-apps/pcsc-lite-1.8.24/work/pcsc-lite-1.8.24/src/eventhandler.c:289:EHStatusHandlerThread()
powerState: POWER_STATE_POWERED
[..snip..]</code></pre></div>
<p>This looks good; the card was recognised.  Next, we'll start the service and let it run on boot.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">$ sudo systemctl start pcscd.service pcscd.socket
$ sudo systemctl enable pcscd.service pcscd.socket</code></pre></div>
<p>The services should now be loaded in systemctl memory and running.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">$ systemctl list-units --type=service,socket --state=running pcsc*
UNIT          LOAD   ACTIVE SUB     DESCRIPTION
pcscd.service loaded active running PC/SC Smart Card Daemon
pcscd.socket  loaded active running PC/SC Smart Card Daemon Activation Socket</code></pre></div>
<p>Finally, we'll confirm that gpg can see the card as well.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">$ gpg --card-status
Reader ...........: Nitrokey Nitrokey Pro (0000000000000000000086BE) 00 00
Application ID ...: D2760001240103030005000086BE0000
Version ..........: 3.3
Manufacturer .....: ZeitControl
Serial number ....: 000086BE
Name of cardholder: [not set]
Language prefs ...: de
Sex ..............: unspecified
URL of public key : [not set]
Login data .......: [not set]
Signature PIN ....: forced
Key attributes ...: rsa2048 rsa2048 rsa2048
Max. PIN lengths .: 64 64 64
PIN retry counter : 3 0 3
Signature counter : 0
KDF setting ......: on
Signature key ....: [none]
Encryption key....: [none]
Authentication key: [none]
General key info..: [none]</code></pre></div>
<p>And gpg looks good too.</p>
<h1>Keypair configuration</h1>
<p>According to the Nitrokey
<a href="https://www.nitrokey.com/files/doc/Nitrokey_Pro_factsheet.pdf">datasheet</a> it
supports RSA-2048 up to RSA-4096 and ECC-256 up to ECC-512 (Brainpool and NIST
algorithms).  For compatibility reasons, it's probably best to use RSA-2048
keypairs despite them being slower and larger than equivalent ECC keypairs.
In this tutorial I show RSA-2048.  For my personal key, I'll use ECC which is
not shown in this tutorial.</p>
<ul>
<li>According to Microsoft Research, ECC (elliptical curve
cryptography) keypairs are <a href="https://eprint.iacr.org/2017/598.pdf">easier to
crack</a> than RSA keypairs with a
sufficiently powerful quantum computer.  </li>
<li>The algorithms supported by the Nitrokey are supposedly vunerable to
side-channel attacks due to not implementing a Montogomery power ladder.</li>
<li>ECC is used for Bitcoin, just secp256k1 which is not supported
by the Nitrokey.</li>
<li>The kernel.org
<a href="https://www.kernel.org/doc/html/latest/process/maintainer-pgp-guide.html">guidelines</a>
say nistp256 is suitable.</li>
</ul>
<p>We'll be creating:</p>
<ul>
<li>All keys: RSA-2048, expiring yearly on 1 August, SHA-2 series output digest</li>
<li>Primary key: certify and signing
** Subkey 1: (encryption)
** Subkey (authentication)</li>
<li>Revocation certificate stored offsite</li>
</ul>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">$ gpg --full-generate-key --expert
gpg (GnuPG) 2.2.15; Copyright (C) 2019 Free Software Foundation, Inc.
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.

Please select what kind of key you want:
   (1) RSA and RSA (default)
   (2) DSA and Elgamal
   (3) DSA (sign only)
   (4) RSA (sign only)
   (7) DSA (set your own capabilities)
   (8) RSA (set your own capabilities)
   (9) ECC and ECC
  (10) ECC (sign only)
  (11) ECC (set your own capabilities)
  (13) Existing key
Your selection? 1
RSA keys may be between 1024 and 4096 bits long.
What keysize do you want? (2048)
Requested keysize is 2048 bits
RSA keys may be between 1024 and 4096 bits long.
What keysize do you want for the subkey? (2048)
Requested keysize is 2048 bits
Please specify how long the key should be valid.
         0 = key does not expire
      &lt;n&gt;  = key expires in n days
      &lt;n&gt;w = key expires in n weeks
      &lt;n&gt;m = key expires in n months
      &lt;n&gt;y = key expires in n years
Key is valid for? (0) 358
Key expires at Sat 01 Aug 2020 20:33:09 BST
Is this correct? (y/N) y

GnuPG needs to construct a user ID to identify your key.

Real name: Antony Jepson
Email address: a@plkt.io
Comment: RSA key for Antony Jepson.  Renewed every 1 August.
You selected this USER-ID:
    &quot;Antony Jepson (RSA key for Antony Jepson.  Renewed every 1 August.) &lt;a@plkt.io&gt;&quot;

Change (N)ame, (C)omment, (E)mail or (O)kay/(Q)uit? o
We need to generate a lot of random bytes. It is a good idea to perform
some other action (type on the keyboard, move the mouse, utilize the
disks) during the prime generation; this gives the random number
generator a better chance to gain enough entropy.
We need to generate a lot of random bytes. It is a good idea to perform
some other action (type on the keyboard, move the mouse, utilize the
disks) during the prime generation; this gives the random number
generator a better chance to gain enough entropy.
gpg: /home/bnt/.gnupg/trustdb.gpg: trustdb created
gpg: key 718044D8003D317A marked as ultimately trusted
gpg: directory &#39;/home/bnt/.gnupg/openpgp-revocs.d&#39; created
gpg: revocation certificate stored as &#39;/home/bnt/.gnupg/openpgp-revocs.d/0F8D4AD674DB570DB095CB3F718044D8003D317A.rev&#39;
public and secret key created and signed.

pub   rsa2048 2019-08-09 [SC] [expires: 2020-08-01]
      0F8D4AD674DB570DB095CB3F718044D8003D317A
uid                      Antony Jepson (RSA key for Antony Jepson.  Renewed every 1 August.) &lt;a@plkt.io&gt;
sub   rsa2048 2019-08-09 [E] [expires: 2020-08-01]

$ gpg --edit-key --expert a@plkt.io
gpg (GnuPG) 2.2.15; Copyright (C) 2019 Free Software Foundation, Inc.
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.

Secret key is available.

gpg: checking the trustdb
gpg: marginals needed: 3  completes needed: 1  trust model: pgp
gpg: depth: 0  valid:   1  signed:   0  trust: 0-, 0q, 0n, 0m, 0f, 1u
gpg: next trustdb check due at 2020-08-01
sec  rsa2048/718044D8003D317A
     created: 2019-08-09  expires: 2020-08-01  usage: SC
     trust: ultimate      validity: ultimate
ssb  rsa2048/692971AD1D29742D
     created: 2019-08-09  expires: 2020-08-01  usage: E
[ultimate] (1). Antony Jepson (RSA key for Antony Jepson.  Renewed every 1 August.) &lt;a@plkt.io&gt;

gpg&gt; addkey
Please select what kind of key you want:
   (3) DSA (sign only)
   (4) RSA (sign only)
   (5) Elgamal (encrypt only)
   (6) RSA (encrypt only)
   (7) DSA (set your own capabilities)
   (8) RSA (set your own capabilities)
  (10) ECC (sign only)
  (11) ECC (set your own capabilities)
  (12) ECC (encrypt only)
  (13) Existing key
Your selection? 8

Possible actions for a RSA key: Sign Encrypt Authenticate
Current allowed actions: Sign Encrypt

   (S) Toggle the sign capability
   (E) Toggle the encrypt capability
   (A) Toggle the authenticate capability
   (Q) Finished

Your selection? A

Possible actions for a RSA key: Sign Encrypt Authenticate
Current allowed actions: Sign Encrypt Authenticate

   (S) Toggle the sign capability
   (E) Toggle the encrypt capability
   (A) Toggle the authenticate capability
   (Q) Finished

Your selection? S

Possible actions for a RSA key: Sign Encrypt Authenticate
Current allowed actions: Encrypt Authenticate

   (S) Toggle the sign capability
   (E) Toggle the encrypt capability
   (A) Toggle the authenticate capability
   (Q) Finished

Your selection? E

Possible actions for a RSA key: Sign Encrypt Authenticate
Current allowed actions: Authenticate

   (S) Toggle the sign capability
   (E) Toggle the encrypt capability
   (A) Toggle the authenticate capability
   (Q) Finished

Your selection? q
RSA keys may be between 1024 and 4096 bits long.
What keysize do you want? (2048)
Requested keysize is 2048 bits
Please specify how long the key should be valid.
         0 = key does not expire
      &lt;n&gt;  = key expires in n days
      &lt;n&gt;w = key expires in n weeks
      &lt;n&gt;m = key expires in n months
      &lt;n&gt;y = key expires in n years
Key is valid for? (0) 358
Key expires at Sat 01 Aug 2020 20:37:48 BST
Is this correct? (y/N) y
Really create? (y/N) y
We need to generate a lot of random bytes. It is a good idea to perform
some other action (type on the keyboard, move the mouse, utilize the
disks) during the prime generation; this gives the random number
generator a better chance to gain enough entropy.

sec  rsa2048/718044D8003D317A
     created: 2019-08-09  expires: 2020-08-01  usage: SC
     trust: ultimate      validity: ultimate
ssb  rsa2048/692971AD1D29742D
     created: 2019-08-09  expires: 2020-08-01  usage: E
ssb  rsa2048/73CCBEF81E3522EB
     created: 2019-08-09  expires: 2020-08-01  usage: A
[ultimate] (1). Antony Jepson (RSA key for Antony Jepson.  Renewed every 1 August.) &lt;a@plkt.io&gt;

gpg&gt; quit
Save changes? (y/N) y</code></pre></div>
<p>Now, back up your key and save it somewhere safe.  We do this now because once
they keys are copied to your Nitrokey they are deleted.</p>
<p><code class="language-text">$ gpg --export-secret-keys a@plkt.io &gt; sec-key.asc</code></p>
<p>Next, we'll copy the keys to the Nitrokey.  First the signature key, then the
encryption key, then the authentication key (for SSH).</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">$ gpg --edit-key --expert a@plkt.io
gpg (GnuPG) 2.2.15; Copyright (C) 2019 Free Software Foundation, Inc.
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.

Secret key is available.

sec  rsa2048/718044D8003D317A
     created: 2019-08-09  expires: 2020-08-01  usage: SC
     trust: ultimate      validity: ultimate
ssb  rsa2048/692971AD1D29742D
     created: 2019-08-09  expires: 2020-08-01  usage: E
ssb  rsa2048/73CCBEF81E3522EB
     created: 2019-08-09  expires: 2020-08-01  usage: A
[ultimate] (1). Antony Jepson (RSA key for Antony Jepson.  Renewed every 1 August.) &lt;a@plkt.io&gt;

gpg&gt; keytocard
Really move the primary key? (y/N) y
Please select where to store the key:
   (1) Signature key
   (3) Authentication key
Your selection? 1

sec  rsa2048/718044D8003D317A
     created: 2019-08-09  expires: 2020-08-01  usage: SC
     trust: ultimate      validity: ultimate
ssb  rsa2048/692971AD1D29742D
     created: 2019-08-09  expires: 2020-08-01  usage: E
ssb  rsa2048/73CCBEF81E3522EB
     created: 2019-08-09  expires: 2020-08-01  usage: A
[ultimate] (1). Antony Jepson (RSA key for Antony Jepson.  Renewed every 1 August.) &lt;a@plkt.io&gt;

gpg&gt; key 1

sec  rsa2048/718044D8003D317A
     created: 2019-08-09  expires: 2020-08-01  usage: SC
     trust: ultimate      validity: ultimate
ssb* rsa2048/692971AD1D29742D
     created: 2019-08-09  expires: 2020-08-01  usage: E
ssb  rsa2048/73CCBEF81E3522EB
     created: 2019-08-09  expires: 2020-08-01  usage: A
[ultimate] (1). Antony Jepson (RSA key for Antony Jepson.  Renewed every 1 August.) &lt;a@plkt.io&gt;

gpg&gt; keytocard
Please select where to store the key:
   (2) Encryption key
Your selection? 2

sec  rsa2048/718044D8003D317A
     created: 2019-08-09  expires: 2020-08-01  usage: SC
     trust: ultimate      validity: ultimate
ssb* rsa2048/692971AD1D29742D
     created: 2019-08-09  expires: 2020-08-01  usage: E
ssb  rsa2048/73CCBEF81E3522EB
     created: 2019-08-09  expires: 2020-08-01  usage: A
[ultimate] (1). Antony Jepson (RSA key for Antony Jepson.  Renewed every 1 August.) &lt;a@plkt.io&gt;

gpg&gt; key 2

sec  rsa2048/718044D8003D317A
     created: 2019-08-09  expires: 2020-08-01  usage: SC
     trust: ultimate      validity: ultimate
ssb* rsa2048/692971AD1D29742D
     created: 2019-08-09  expires: 2020-08-01  usage: E
ssb* rsa2048/73CCBEF81E3522EB
     created: 2019-08-09  expires: 2020-08-01  usage: A
[ultimate] (1). Antony Jepson (RSA key for Antony Jepson.  Renewed every 1 August.) &lt;a@plkt.io&gt;

gpg&gt; key 1

sec  rsa2048/718044D8003D317A
     created: 2019-08-09  expires: 2020-08-01  usage: SC
     trust: ultimate      validity: ultimate
ssb  rsa2048/692971AD1D29742D
     created: 2019-08-09  expires: 2020-08-01  usage: E
ssb* rsa2048/73CCBEF81E3522EB
     created: 2019-08-09  expires: 2020-08-01  usage: A
[ultimate] (1). Antony Jepson (RSA key for Antony Jepson.  Renewed every 1 August.) &lt;a@plkt.io&gt;

gpg&gt; keytocard
Please select where to store the key:
   (3) Authentication key
Your selection? 3

sec  rsa2048/718044D8003D317A
     created: 2019-08-09  expires: 2020-08-01  usage: SC
     trust: ultimate      validity: ultimate
ssb  rsa2048/692971AD1D29742D
     created: 2019-08-09  expires: 2020-08-01  usage: E
ssb* rsa2048/73CCBEF81E3522EB
     created: 2019-08-09  expires: 2020-08-01  usage: A
[ultimate] (1). Antony Jepson (RSA key for Antony Jepson.  Renewed every 1 August.) &lt;a@plkt.io&gt;

gpg&gt; quit
Save changes? (y/N) y</code></pre></div>
<p>The public key can be exported and stored in any easily retrievable place.</p>
<p><code class="language-text">$ gpg --armor --export a@plkt.io &gt; pubkey.asc</code></p>
<p>Here's the final state of the Nitrokey.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">$ gpg --card-edit

Reader ...........: Nitrokey Nitrokey Pro (0000000000000000000086BE) 00 00
Application ID ...: D2760001240103030005000086BE0000
Version ..........: 3.3
Manufacturer .....: ZeitControl
Serial number ....: 000086BE
Name of cardholder: [not set]
Language prefs ...: de
Sex ..............: unspecified
URL of public key : [not set]
Login data .......: [not set]
Signature PIN ....: forced
Key attributes ...: rsa2048 rsa2048 rsa2048
Max. PIN lengths .: 64 64 64
PIN retry counter : 3 0 3
Signature counter : 0
KDF setting ......: on
Signature key ....: 0F8D 4AD6 74DB 570D B095  CB3F 7180 44D8 003D 317A
      created ....: 2019-08-09 19:34:03
Encryption key....: FECA 217D E1E5 96AA A7F5  86F1 6929 71AD 1D29 742D
      created ....: 2019-08-09 19:34:03
Authentication key: D6CF ED7E FA74 999D 2E99  AEE4 73CC BEF8 1E35 22EB
      created ....: 2019-08-09 19:36:50
General key info..:
pub  rsa2048/718044D8003D317A 2019-08-09 Antony Jepson (RSA key for Antony Jepson.  Renewed every 1 August.) &lt;a@plkt.io&gt;
sec&gt;  rsa2048/718044D8003D317A  created: 2019-08-09  expires: 2020-08-01
                                card-no: 0005 000086BE
ssb&gt;  rsa2048/692971AD1D29742D  created: 2019-08-09  expires: 2020-08-01
                                card-no: 0005 000086BE
ssb&gt;  rsa2048/73CCBEF81E3522EB  created: 2019-08-09  expires: 2020-08-01
                                card-no: 0005 000086BE

gpg/card&gt; quit</code></pre></div>
<p>More information available on Nitrokey's website (guide)[https://www.nitrokey.com/documentation/openpgp-create-backup].</p>
<p>The keys shown in this example are just for reference.  My actual public key is stored at <strong><a href="https://plkt.io/key">https://plkt.io/key</a></strong>.</p>
<h1>Using the keypair</h1>
<p>So I think for most people this is the stopping point -- people don't actually
integrate it into their flow.  Here's the references I used for integrating it
into my daily flow. </p>
<h2>Signing code commits</h2>
<p>GitHub has a <a href="https://help.github.com/en/articles/signing-commits">great guide</a>.</p>
<p>In the local repository, issue <code class="language-text">git config commit.gpgsign true</code>.  Then when you
commit, add the S flag: <code class="language-text">git commit -S -m commit message</code>.</p>
<h2>Encrypting and signing email</h2>
<p>I use a mixture of Outlook and Mutt for email.  I use Outlook for day-to-day
email and Mutt for mailing lists and important emails.  See the Mutt
<a href="https://gitlab.com/muttmua/mutt/wikis/MuttGuide/UseGPG">documentation</a> for
help.</p>
<h2>Logging into remote systems</h2>
<p>Two helpful guides: <a href="https://wiki.archlinux.org/index.php/GnuPG#SSH_agent">Arch
Wiki</a> and the top Google
result <a href="https://eklitzke.org/using-gpg-agent-effectively">Using gpg-agent
effectively</a>.</p>
<h2>Encrypting files</h2>
<p>Use the official <a href="https://www.gnupg.org/gph/en/manual/x110.html">GPG
documentation</a>.</p>
<h1>Summary</h1>
<p>Using public keys with a smart card wasn't as difficult as expected.  I think
you need to incrementally introduce it into your habits over time.  Start by
occasionally sending encrypted email -- see how people respond.  Attach the
digest to the email instead of including it inline.</p>
<p>Let me know if you found any issues with the instructions above.</p></div></div></div></main><footer><small><br/><hr/>Built with<!-- --> <a href="https://www.gatsbyjs.org">Gatsby</a>,<!-- --> <a href="https://code.visualstudio.com/">VSCode</a>,<!-- --> <a href="https://www.gentoo.org">Gentoo</a>,<!-- --> <a href="https://aws.amazon.com/amplify/">Amplify</a>,<!-- --> and <a href="https://reactjs.org/">React</a><br/>© 2008 to <!-- -->2019<!-- --> Antony Jepson <div><a href=""></a></div></small></footer></div></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-144235537-1', 'auto', {});
      
      
      
      
      
      }</script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/writing/integrating-nitrokey";window.webpackCompilationHash="00a56055d7b748fecd97";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-010e7023b2ceb6cc2e86.js"],"component---src-templates-blog-template-js":["/component---src-templates-blog-template-js-1bb93a169f96d271cd24.js"],"component---src-pages-404-js":["/component---src-pages-404-js-65e52d15067a529c9c11.js"],"component---src-pages-bookshelf-js":["/component---src-pages-bookshelf-js-56233651dfdb210f5abf.js"],"component---src-pages-contact-js":["/component---src-pages-contact-js-1189a5d1682a20091712.js"],"component---src-pages-index-js":["/component---src-pages-index-js-763dbe15196120559907.js"]};/*]]>*/</script><script src="/webpack-runtime-1ae3d3dba2dc090e4602.js" async=""></script><script src="/commons-fa205ddb4d04c9cc16a5.js" async=""></script><script src="/component---src-templates-blog-template-js-1bb93a169f96d271cd24.js" async=""></script><script src="/app-010e7023b2ceb6cc2e86.js" async=""></script></body></html>